<!DOCTYPE html>
<html lang="eu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zenbaki Osoak / Números Enteros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
      body.font-arabic { font-family: 'Cairo', sans-serif; }
      .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
      .animate-slide-up { animation: slideUp 0.3s ease-out; }
      @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
      @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        ArrowRight, ArrowLeft, BookOpen, Calculator, Home, Layout, Star, Menu, X, 
        RefreshCw, CheckCircle, AlertCircle, HelpCircle, Check, Lightbulb, Snowflake, 
        Sun, ThumbsUp, ThumbsDown, Globe, Trophy, User, LogOut, Timer, Trash2, Lock,
        Shield, ShieldAlert, Ban, Activity, Eye, EyeOff, Monitor, Smartphone, AlertTriangle,
        Plus, Minus
      } from 'lucide-react';
      
      // --- FIREBASE SETUP ---
      import { initializeApp } from 'firebase/app';
      import { getDatabase, ref, get, set, child, remove, update } from 'firebase/database';

      // ⚠️⚠️ PASTE YOUR FIREBASE CONFIG HERE ⚠️⚠️
      const FIREBASE_CONFIG = null; 

      let db = null;
      if (FIREBASE_CONFIG) {
        const app = initializeApp(FIREBASE_CONFIG);
        db = getDatabase(app);
      }

      // --- STORAGE MANAGER ---
      const DB_KEY = 'zenbaki_osoak_users_v2';
      const DEVICE_ID_KEY = 'zenbaki_device_id';

      const StorageManager = {
        getDeviceId: () => {
           let did = localStorage.getItem(DEVICE_ID_KEY);
           if (!did) {
             did = 'dev-' + Math.random().toString(36).substr(2, 9);
             localStorage.setItem(DEVICE_ID_KEY, did);
           }
           return did;
        },

        getAllUsers: async () => {
          if (db) {
            try {
              const snapshot = await get(ref(db, 'users'));
              if (snapshot.exists()) {
                const data = snapshot.val();
                return Object.values(data);
              }
              return [];
            } catch (e) {
              console.error("Firebase Error:", e);
              return [];
            }
          } else {
            return JSON.parse(localStorage.getItem(DB_KEY) || '[]');
          }
        },

        saveLocal: (users) => {
          localStorage.setItem(DB_KEY, JSON.stringify(users));
        },

        register: async (username, password, ip, deviceId) => {
          if (username.toLowerCase() === 'admin') return { success: false, error: 'reserved' };
          
          const users = await StorageManager.getAllUsers();
          if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
            return { success: false, error: 'exists' };
          }
          
          const newUser = { 
            username, password, ip, deviceId, banned: false, scores: {} 
          };

          if (db) {
            await set(ref(db, 'users/' + username), newUser);
          } else {
            users.push(newUser);
            StorageManager.saveLocal(users);
          }
          return { success: true, user: newUser };
        },

        login: async (username, password, ip, deviceId) => {
          if (username === 'Admin' && password === 'Pepito232') {
             return { success: true, user: { username: 'Admin', isAdmin: true } };
          }

          const users = await StorageManager.getAllUsers();
          const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
          
          if (user) {
             if (user.banned) return { success: false, error: 'banned' };
             
             const updatedUser = { ...user, ip, deviceId };
             if (db) {
                await update(ref(db, 'users/' + user.username), { ip, deviceId });
             } else {
                const idx = users.findIndex(u => u.username === user.username);
                users[idx] = updatedUser;
                StorageManager.saveLocal(users);
             }
             return { success: true, user: updatedUser };
          }
          return { success: false, error: 'cred' };
        },

        deleteUser: async (username) => {
          if (db) {
            await remove(ref(db, 'users/' + username));
            return true;
          } else {
            let users = await StorageManager.getAllUsers();
            const initLen = users.length;
            users = users.filter(u => u.username !== username);
            if (users.length < initLen) {
               StorageManager.saveLocal(users);
               return true;
            }
            return false;
          }
        },

        checkUserStatus: async (username) => {
          if (db) {
            const snapshot = await get(ref(db, 'users/' + username));
            if (!snapshot.exists()) return 'deleted';
            if (snapshot.val().banned) return 'banned';
            return 'ok';
          } else {
            const users = await StorageManager.getAllUsers();
            const u = users.find(u => u.username === username);
            if (!u) return 'deleted';
            if (u.banned) return 'banned';
            return 'ok';
          }
        },

        saveScore: async (username, gameId, score) => {
          const users = await StorageManager.getAllUsers();
          const user = users.find(u => u.username === username);
          if (!user) return { isNewRecord: false };

          const currentScore = user.scores?.[gameId] || 0;
          if (score > currentScore) {
             if (db) {
               await update(ref(db, `users/${username}/scores`), { [gameId]: score });
               return { isNewRecord: true, user: { ...user, scores: { ...user.scores, [gameId]: score } } };
             } else {
               user.scores = user.scores || {};
               user.scores[gameId] = score;
               StorageManager.saveLocal(users);
               return { isNewRecord: true, user };
             }
          }
          return { isNewRecord: false, user };
        }
      };

      // --- TRANSLATIONS ---
      const TRANSLATIONS = {
        eu: {
          title: "Zenbaki Osoak",
          intro_desc: "Mundu errealean, zenbakiak ez dira beti positiboak. Zorrak, hotza, eta sotoak adierazteko... negatiboak behar ditugu!",
          nav: { intro: "Zer dira?", line: "Ordena", ops: "Eragiketak", probs: "Problemak", games: "Jolastu", records: "Errekorrak", profile: "Profila" },
          auth: { login_title: "Sartu", register_title: "Erregistratu", user_ph: "Erabiltzailea", pass_ph: "Pasahitza", btn_login: "Sartu", btn_register: "Erregistratu", no_account: "Ez duzu konturik?", has_account: "Baduzu kontua?", error_exists: "Erabiltzailea existitzen da", error_reserved: "Izen hori ezin da erabili", error_cred: "Datuak okerrak dira", error_banned: "KONTUA BLOKEATUTA. Adminarekin hitz egin.", welcome: "Ongi etorri" },
          admin: { title: "Administrazio Panela", subtitle: "Erabiltzaileen kontrola eta segurtasuna", col_user: "Erabiltzailea", col_ip: "IP Helbidea", col_device: "ID Gailua", col_pass: "Pasahitza", col_score: "Markak (Ops/TF/Pyr)", col_status: "Egoera", col_actions: "Ekintzak", status_ok: "Aktibo", status_ban: "Kanporatua", btn_ban: "Kanporatu", btn_unban: "Onartu", btn_cancel: "Ezeztatu", no_users: "Ez dago erabiltzailerik sisteman.", logout: "Irten paneletik", confirm_ban: "Ziur erabiltzaile hau betirako ezabatu nahi duzula?" },
          records: { title: "Errekorren Gela", subtitle: "1 minutu. Ahalik eta gehien asmatu. +1 Asmatu, -2 Huts egin.", start: "Hasi Erronka", time: "Denbora", score: "Puntuak", game_ops: "Nahasia", game_pyr: "Piramideak", game_tf: "Egia ala Gezurra", game_compare: "Konparatu", game_add: "Batuketak", game_sub: "Kenketak", game_mul: "Biderketak", game_comb: "Konbinatuak", new_record: "ERREKOR BERRIA!", final_score: "Amaierako Puntuazioa", leaderboard: "Top 3 Sailkapena", no_scores: "Oraindik ez dago markarik", back: "Itzuli", check: "Egiaztatu" },
          profile: { title: "Zure Profila", best_scores: "Marka Onenak", delete_acc: "Ezabatu Kontua", logout: "Saioa itxi", confirm_del: "Ziur zaude? Ezin da desegin." },
          thermometer: { title: "Tenperatura eta Zenbakiak", desc: "Termometroak zenbaki osoak ulertzeko balio du.", ref: "Zero (0) erreferentzia da.", pos: "Zerotik gora: Positiboak (+)", neg: "Zerotik behera: Negatiboak (-)", label: "Mugitu tenperatura:", above: "Zero gainetik", below: "Zero azpitik", zero: "Zero" },
          elevator: { title: "Igogailua", desc: "Eraikinetan, sotoak adierazteko zenbaki negatiboak erabiltzen ditugu.", floor0: "Behea", floor1: "1. Sotoa", floor_label: "Sol", basement_label: "Soto" },
          sets: { title: "Zenbaki multzoak", N: "N (Arruntak)", Z: "Z (Osoak)" },
          numberline: { title: "Zuzen Numerikoa", desc: "Egin klik zenbakietan. Eskuinean dauden zenbakiak beti handiagoak dira. Ezkerrean daudenak, txikiagoak.", neg: "Negatiboa", pos: "Positiboa", zero: "Zeroa", smaller: "Txikiagoak", bigger: "Handiagoak", hunt_title: "Non daude?", hunt_desc: "Idatzi letra bakoitzari dagokion zenbaki osoa.", check: "Egiaztatu" },
          ops: { title: "Eragiketak", subtitle: "Parentesiak kentzeko araua ikasi.", same: "Berdinak", diff: "Ezberdinak", hint_title: "Aholkua", hint: "Zeinu berdinak → (+), Zeinu ezberdinak → (-)", correct: "Zuzena! Bikain!", wrong: "Okerra... begiratu ondo zeinuak!", skip: "Saltatu", modes: { compare: "Konparatu", add: "Batuketak", subtract: "Kenketak", multiply: "Biderketak", combined: "Konbinatuak" } },
          problems: { title: "Problemak", subtitle: "Erabili zenbaki osoak eguneroko egoeretan.", rem_title: "Gogoratu!", rem_text: "\"Zorrak\", \"gastatu\" eta \"K.a.\" negatiboak dira. \"Irabazi\", \"eman\" eta \"K.o.\" positiboak dira.", label: "Problema", hint_btn: "Pistatxo bat nahi?", hint_prefix: "Pista", next: "Hurrengoa", check: "Egiaztatu", correct: "Zuzena! Oso ongi!", wrong: "Saiatu berriro..." },
          games: { title: "Jolas Gunea", subtitle: "Ikasi jolasten!", pyramid: { title: "Piramide Magikoa", desc: "Beheko bi laukien batura goikoa da." }, tf: { title: "Egia ala Gezurra?", true: "Egia", false: "Gezurra", streak: "Racha" }, memory: { title: "Bikoteak Bilatu", won: "Zorionak! Guztiak aurkitu dituzu!" } },
          footer: "Eremu Zientifiko Matematikoa - 1. DBH"
        },
        es: {
          title: "Números Enteros",
          intro_desc: "En el mundo real, los números no siempre son positivos. ¡Para las deudas, el frío y los sótanos... necesitamos negativos!",
          nav: { intro: "¿Qué son?", line: "Orden", ops: "Operaciones", probs: "Problemas", games: "Jugar", records: "Récords", profile: "Perfil" },
          auth: { login_title: "Entrar", register_title: "Registrarse", user_ph: "Usuario", pass_ph: "Contraseña", btn_login: "Entrar", btn_register: "Crear cuenta", no_account: "¿No tienes cuenta?", has_account: "¿Ya tienes cuenta?", error_exists: "El usuario ya existe", error_reserved: "Nombre reservado", error_cred: "Datos incorrectos", error_banned: "CUENTA BLOQUEADA. Contacta al Admin.", welcome: "Bienvenido" },
          admin: { title: "Panel de Administración", subtitle: "Control de usuarios y seguridad", col_user: "Usuario", col_ip: "Dirección IP", col_device: "ID Dispositivo", col_pass: "Contraseña", col_score: "Récords", col_status: "Estado", col_actions: "Acciones", status_ok: "Activo", status_ban: "Expulsado", btn_ban: "Kanporatu", btn_unban: "Readmitir", btn_cancel: "Cancelar", no_users: "No hay usuarios en el sistema.", logout: "Salir del panel", confirm_ban: "¿Seguro que quieres eliminar definitivamente a este usuario?" },
          records: { title: "Sala de Récords", subtitle: "1 minuto. Acierta el máximo posible. +1 Acierto, -2 Fallo.", start: "Empezar Reto", time: "Tiempo", score: "Puntos", game_ops: "Popurrí", game_pyr: "Pirámides", game_tf: "Verdadero o Falso", game_compare: "Comparar", game_add: "Sumas", game_sub: "Restas", game_mul: "Multiplicar", game_comb: "Combinadas", new_record: "¡NUEVO RÉCORD!", final_score: "Puntuación Final", leaderboard: "Top 3 Clasificación", no_scores: "Aún no hay marcas", back: "Volver", check: "Comprobar" },
          profile: { title: "Tu Perfil", best_scores: "Mejores Marcas", delete_acc: "Borrar Cuenta", logout: "Cerrar Sesión", confirm_del: "¿Seguro? No se puede deshacer." },
          thermometer: { title: "Temperatura y Números", desc: "El termómetro sirve para entender los números enteros.", ref: "El cero (0) es la referencia.", pos: "Sobre cero: Positivos (+)", neg: "Bajo cero: Negativos (-)", label: "Mueve la temperatura:", above: "Sobre cero", below: "Bajo cero", zero: "Cero" },
          elevator: { title: "El Ascensor", desc: "En los edificios, usamos números negativos para los sótanos.", floor0: "Baja", floor1: "Sótano 1", floor_label: "Piso", basement_label: "Sót" },
          sets: { title: "Conjuntos numéricos", N: "N (Naturales)", Z: "Z (Enteros)" },
          numberline: { title: "Recta Numérica", desc: "Haz clic en los números. A la derecha siempre son mayores. A la izquierda, menores.", neg: "Negativo", pos: "Positivo", zero: "Cero", smaller: "Menores", bigger: "Mayores", hunt_title: "¿Dónde están?", hunt_desc: "Escribe el número entero correspondiente a cada letra.", check: "Comprobar" },
          ops: { title: "Operaciones", subtitle: "Aprende la regla para quitar paréntesis.", same: "Iguales", diff: "Diferentes", hint_title: "Consejo", hint: "Signos iguales → (+), Signos diferentes → (-)", correct: "¡Correcto! ¡Genial!", wrong: "Incorrecto... ¡mira bien los signos!", skip: "Saltar", modes: { compare: "Comparar", add: "Sumas", subtract: "Restas", multiply: "Multiplicar", combined: "Combinadas" } },
          problems: { title: "Problemas", subtitle: "Usa los números enteros en situaciones cotidianas.", rem_title: "¡Recuerda!", rem_text: "\"Deudas\", \"gastar\" y \"A.C.\" son negativos. \"Ganar\", \"dar\" y \"D.C.\" son positivos.", label: "Problema", hint_btn: "¿Quieres una pista?", hint_prefix: "Pista", next: "Siguiente", check: "Comprobar", correct: "¡Correcto! ¡Muy bien!", wrong: "Inténtalo de nuevo..." },
          games: { title: "Zona de Juegos", subtitle: "¡Aprende jugando!", pyramid: { title: "Pirámide Mágica", desc: "La suma de los dos bloques de abajo es el de arriba." }, tf: { title: "¿Verdadero o Falso?", true: "Verdadero", false: "Falso", streak: "Racha" }, memory: { title: "Buscar Parejas", won: "¡Felicidades! ¡Las has encontrado todas!" } },
          footer: "Ámbito Científico Matemático - 1º ESO"
        },
        ar: {
          title: "الأعداد الصحيحة",
          intro_desc: "في العالم الحقيقي، الأرقام ليست دائماً موجبة. للديون، والبرد، والأقبية... نحتاج إلى السلبيات!",
          nav: { intro: "ما هي؟", line: "الترتيب", ops: "العمليات", probs: "مسائل", games: "لعب", records: "أرقام قياسية", profile: "ملف" },
          auth: { login_title: "دخول", register_title: "تسجيل", user_ph: "اسم المستخدم", pass_ph: "كلمة المرور", btn_login: "دخول", btn_register: "إنشاء حساب", no_account: "ليس لديك حساب؟", has_account: "لديك حساب بالفعل؟", error_exists: "المستخدم موجود بالفعل", error_reserved: "هذا الاسم محجوز", error_cred: "بيانات غير صحيحة", error_banned: "حساب محظور. اتصل بالمسؤول.", welcome: "أهلاً بك" },
          admin: { title: "لوحة التحكم", subtitle: "التحكم بالمستخدمين والأمان", col_user: "المستخدم", col_ip: "عنوان IP", col_device: "معرف الجهاز", col_pass: "كلمة المرور", col_score: "النتائج", col_status: "الحالة", col_actions: "إجراءات", status_ok: "نشط", status_ban: "مطرود", btn_ban: "طرد", btn_unban: "إلغاء الحظر", btn_cancel: "إلغاء", no_users: "لا يوجد مستخدمين", logout: "خروج", confirm_ban: "هل أنت متأكد من حذف هذا المستخدم؟" },
          records: { title: "قاعة الأرقام القياسية", subtitle: "دقيقة واحدة. احصل على أقصى عدد. +1 صحيح، -2 خطأ.", start: "ابدأ التحدي", time: "الوقت", score: "النقاط", game_ops: "مختلط", game_pyr: "أهرامات", game_tf: "صح أم خطأ", game_compare: "مقارنة", game_add: "جمع", game_sub: "طرح", game_mul: "ضرب", game_comb: "مختلطة", new_record: "رقم قياسي جديد!", final_score: "النتيجة النهائية", leaderboard: "أفضل 3 مراكز", no_scores: "لا توجد أرقام حتى الآن", back: "رجوع", check: "تحقق" },
          profile: { title: "ملفك الشخصي", best_scores: "أفضل النتائج", delete_acc: "حذف الحساب", logout: "تسجيل خروج", confirm_del: "هل أنت متأكد؟ لا يمكن التراجع." },
          thermometer: { title: "درجة الحرارة والأرقام", desc: "مقياس الحرارة يساعد في فهم الأعداد الصحيحة.", ref: "الصفر (0) هو المرجع.", pos: "فوق الصفر: موجب (+)", neg: "تحت الصفر: سالب (-)", label: "حرك درجة الحرارة:", above: "فوق الصفر", below: "تحت الصفر", zero: "صفر" },
          elevator: { title: "المصعد", desc: "في المباني، نستخدم الأرقام السالبة للأقبية.", floor0: "أرضي", floor1: "قبو 1", floor_label: "طابق", basement_label: "قبو" },
          sets: { title: "مجموعات الأعداد", N: "N (طبيعية)", Z: "Z (صحيحة)" },
          numberline: { title: "خط الأعداد", desc: "انقر على الأرقام. الأرقام على اليمين دائماً أكبر. وعلى اليسار أصغر.", neg: "سالب", pos: "موجب", zero: "صفر", smaller: "أصغر", bigger: "أكبر", hunt_title: "أين هم؟", hunt_desc: "اكتب العدد الصحيح الموافق لكل حرف.", check: "تحقق" },
          ops: { title: "العمليات", subtitle: "تعلم قاعدة إزالة الأقواس.", same: "متشابهة", diff: "مختلفة", hint_title: "نصيحة", hint: "إشارات متشابهة ← (+)، إشارات مختلفة ← (-)", correct: "صحيح! رائع!", wrong: "خطأ... انظر جيداً إلى الإشارات!", skip: "تخطى", modes: { compare: "مقارنة", add: "جمع", subtract: "طرح", multiply: "ضرب", combined: "مختلطة" } },
          problems: { title: "مسائل", subtitle: "استخدم الأعداد الصحيحة في الحياة اليومية.", rem_title: "تذكر!", rem_text: "\"الديون\"، \"إنفاق\" و \"قبل الميلاد\" سلبية. \"كسب\"، \"إعطاء\" و \"بعد الميلاد\" إيجابية.", label: "مسألة", hint_btn: "هل تريد تلميحاً؟", hint_prefix: "تلميح", next: "التالي", check: "تحقق", correct: "صحيح! أحسنت!", wrong: "حاول مرة أخرى..." },
          games: { title: "منطقة الألعاب", subtitle: "تعلم باللعب!", pyramid: { title: "الهرم السحري", desc: "مجموع المربعين السفليين يساوي العلوي." }, tf: { title: "صح أم خطأ؟", true: "صح", false: "خطأ", streak: "متتالية" }, memory: { title: "البحث عن الأزواج", won: "مبروك! لقد وجدت الجميع!" } },
          footer: "المجال العلمي الرياضي - الصف الأول الإعدادي"
        }
      };

      // --- MATH LOGIC ---
      const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
      const fmt = (n) => n < 0 ? `(${n})` : `${n}`;

      // 1. Operations & Smart Distractors
      const generateOperation = (type, lang) => {
        let question = '', answer = 0;
        if (type === 'combined') {
          const subtype = randomInt(1, 3);
          const a = randomInt(-6, 6), b = randomInt(-6, 6), c = randomInt(-5, 5);
          if (subtype === 1) { 
              // a + b * c
              question = `${fmt(a)} + ${fmt(b)} · ${fmt(c)}`; 
              answer = a + (b * c); 
          } else if (subtype === 2) { 
              // (a + b) * c
              question = `(${a} + ${fmt(b)}) · ${fmt(c)}`; 
              answer = (a + b) * c; 
          } else { 
              // a - b - c
              question = `${fmt(a)} - ${fmt(b)} - ${fmt(c)}`; 
              answer = a - b - c; 
          }
        } else {
          let a = randomInt(-10, 10), b = randomInt(-10, 10);
          if (type === 'add') { question = `${a} + (${b})`; answer = a + b; }
          else if (type === 'subtract') { question = `${a} - (${b})`; answer = a - b; }
          else if (type === 'multiply') { question = `${a} · (${b})`; answer = a * b; }
        }
        
        // Smart Distractors
        const options = [answer];
        // 1. Sign Error
        if (answer !== 0 && !options.includes(-answer)) options.push(-answer);
        
        // 2. Operation Error (Add instead of subtract or vice versa)
        // e.g. 3 - (-3) = 6. Distractor: 3 + (-3) = 0.
        if (type === 'subtract' || (type === 'combined' && question.includes('-'))) {
             // Try "removing double negative" incorrectly
             // If we don't parse the question fully, we can just guess plausible errors:
             // 0 is a very common wrong answer for things like -3 - (-3) or -3 + 3
             if (!options.includes(0)) options.push(0);
        }

        while (options.length < 4) {
          let fake;
          const r = Math.random();
          if (r < 0.33) fake = answer + randomInt(-5, 5);
          else if (r < 0.66) fake = randomInt(-20, 20);
          else fake = answer + (Math.random() > 0.5 ? 10 : -10);

          if (fake !== answer && !options.includes(fake)) options.push(fake);
        }
        return { id: Math.random().toString(), question, correctAnswer: answer, options: options.sort(() => Math.random() - 0.5), type };
      };

      const generateComparison = () => {
         const a = randomInt(-20, 20); let b = randomInt(-20, 20);
         while (a === b) b = randomInt(-20, 20);
         return { id: Math.random().toString(), question: `> ? <`, correctAnswer: Math.max(a, b), options: [a, b], type: 'compare' };
      };

      const generateTrueFalse = () => {
         const type = randomInt(1, 2);
         if (type === 1) {
             const a = randomInt(-10, 10), b = randomInt(-10, 10);
             if (a===b) return generateTrueFalse();
             const sym = Math.random() > 0.5 ? '>' : '<';
             return { id: Math.random().toString(), statement: `${a} ${sym} ${b}`, isTrue: sym === '>' ? a > b : a < b, explanation: `${a} ${sym==='>' ? (a>b?'HANDIA da':'EZ da handia') : (a<b?'TXIKIA da':'EZ da txikia')} ${b} baino` };
         } else {
             const a = randomInt(-8, 8), b = randomInt(-8, 8), res = a+b;
             const shown = Math.random() > 0.5 ? res : res + randomInt(-3, 3);
             return { id: Math.random().toString(), statement: `${fmt(a)} + ${fmt(b)} = ${shown===res && Math.random()>0.5 ? res+1 : shown}`, isTrue: shown === res, explanation: `${fmt(a)} + ${fmt(b)} = ${res}` };
         }
      };

      const generatePyramid = () => {
         const c=randomInt(-5,5), d=randomInt(-5,5), e=randomInt(-5,5);
         const a=c+d, b=d+e, top=a+b;
         const cells=[{id:'top',value:top,isInput:Math.random()>0.5,row:0,col:0},{id:'a',value:a,isInput:Math.random()>0.5,row:1,col:0},{id:'b',value:b,isInput:Math.random()>0.5,row:1,col:1},{id:'c',value:c,isInput:Math.random()>0.5,row:2,col:0},{id:'d',value:d,isInput:Math.random()>0.5,row:2,col:1},{id:'e',value:e,isInput:Math.random()>0.5,row:2,col:2}];
         let vis=cells.filter(x=>!x.isInput).length;
         while(vis<3){ const i=randomInt(0,5); if(cells[i].isInput){cells[i].isInput=false; vis++;}}
         return cells;
      };

      const generateMemoryDeck = () => {
         const p = [{q:"-2+5",a:"3",v:3}, {q:"-3-2",a:"-5",v:-5}, {q:"-1+1",a:"0",v:0}, {q:"2·(-3)",a:"-6",v:-6}, {q:"-4-4",a:"-8",v:-8}, {q:"10:(-2)",a:"-5",v:-50}];
         const sel = p.sort(()=>Math.random()-0.5).slice(0,4);
         const c=[]; sel.forEach(x=>{c.push({id:`q-${x.v}`,content:x.q,matchId:x.v,isFlipped:false,isMatched:false},{id:`a-${x.v}`,content:x.a,matchId:x.v,isFlipped:false,isMatched:false})});
         return c.sort(()=>Math.random()-0.5);
      };

      // 2. Word Problems Generator
      const generateWordProblem = () => {
        const scenarios = [
            { t: 'elevator', f: () => { const s=randomInt(0,5), m=randomInt(2,6), e=s-m; return { text: `Igogailua ${s}. solairuan dago. ${m} solairu jaitsi ditu. Zein solairutan dago orain?`, correctAnswer: e, unit: 'solairuan', hint: `${s} - ${m} = ?` }; } },
            { t: 'temp', f: () => { const s=randomInt(-5,5), c=randomInt(2,8), d=Math.random()>0.5, e=d?s-c:s+c; return { text: `Tenperatura ${s}ºC-koa zen. Gero ${c}ºC ${d?'jaitsi':'igo'} da. Zein da tenperatura berria?`, correctAnswer: e, unit: 'ºC', hint: d?`${s}-${c}`:`${s}+${c}` }; } },
            { t: 'money', f: () => { const b=randomInt(10,50), d=randomInt(15,60); return { text: `Poltsikoan ${b}€ dituzu, baina ${d}€ zor dizkiozu. Saldo erreala?`, correctAnswer: b-d, unit: '€', hint: `${b} - ${d}` }; } },
            { t: 'hist', f: () => { const b=randomInt(10,100), a=randomInt(30,80), e=-b+a; return { text: `Matematikari bat K.a. ${b}. urtean jaio zen eta ${a} urte bizi izan zen. Noiz hil zen?`, correctAnswer: e, unit: 'urtean', hint: `-${b} + ${a}` }; } },
            { t: 'sub', f: () => { const d=randomInt(10,50), x=randomInt(5,20); return { text: `Urpekari bat ${d}m-ko sakoneran dago. ${x}m gehiago jaitsi da.`, correctAnswer: -(d+x), unit: 'm', hint: `-${d} - ${x}` }; } },
            { t: 'game', f: () => { const p=randomInt(5,20), pen=randomInt(25,50); return { text: `Jokoan ${p} puntu zenituen, baina ${pen} kendu dizkizute.`, correctAnswer: p-pen, unit: 'pts', hint: `${p} - ${pen}` }; } }
        ];
        return { id: Math.random().toString(), ...scenarios[randomInt(0,5)].f() };
      };

      // 3. Number Line Hunt Generator
      const generateNumberLinePoints = () => {
         const pts = [], used = new Set();
         ['A','B','C'].forEach(l => {
             let v = randomInt(-6,6); while(used.has(v)) v=randomInt(-6,6); used.add(v);
             pts.push({id:l, label:l, value:v});
         });
         return pts;
      };

      // --- COMPONENTS ---

      const LanguageSelector = ({ current, onChange }) => (
        <div className="flex items-center gap-2"><Globe size={18} className="text-slate-500"/><select value={current} onChange={e=>onChange(e.target.value)} className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg p-1.5"><option value="eu">Euskara</option><option value="es">Español</option><option value="ar">العربية</option></select></div>
      );

      const AuthScreen = ({ lang, onLogin }) => {
        const [isReg, setIsReg] = useState(false);
        const [u, setU] = useState('');
        const [p, setP] = useState('');
        const [err, setErr] = useState('');
        const [ip, setIp] = useState('Wait...');
        const [did, setDid] = useState('');
        
        useEffect(() => {
           const d = StorageManager.getDeviceId();
           setDid(d);
           setIp(`Loc-${d.substr(4,4)}`);
           fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>setIp(d.ip)).catch(()=>{});
        }, []);

        const sub = async (e) => {
           e.preventDefault();
           if(!u || !p) return;
           if(isReg) {
              const r = await StorageManager.register(u, p, ip, did);
              if(r.success) onLogin(r.user); else setErr(r.error);
           } else {
              const r = await StorageManager.login(u, p, ip, did);
              if(r.success) onLogin(r.user); else setErr(r.error);
           }
        };

        const t = TRANSLATIONS[lang].auth;
        return (
           <div className="min-h-[80vh] flex items-center justify-center p-4">
              <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full">
                 <h1 className="text-2xl font-bold text-center mb-6">{isReg ? t.register_title : t.login_title}</h1>
                 {!FIREBASE_CONFIG && <div className="mb-4 text-xs bg-yellow-50 text-yellow-700 p-2 rounded text-center">Modo Local (Sin Base de Datos)</div>}
                 <form onSubmit={sub} className="space-y-4">
                    <input className="w-full p-3 border rounded-xl" placeholder={t.user_ph} value={u} onChange={e=>setU(e.target.value)} />
                    <input className="w-full p-3 border rounded-xl" type="password" placeholder={t.pass_ph} value={p} onChange={e=>setP(e.target.value)} />
                    <div className="text-xs text-center text-slate-400">IP: {ip}</div>
                    {err && <div className="text-red-500 text-center font-bold">{err}</div>}
                    <button className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">{isReg ? t.btn_register : t.btn_login}</button>
                 </form>
                 <button onClick={()=>setIsReg(!isReg)} className="w-full mt-4 text-indigo-600 text-sm font-bold">{isReg ? t.has_account : t.no_account}</button>
              </div>
           </div>
        );
      };

      const AdminPanel = ({ lang, onLogout }) => {
          const [users, setUsers] = useState([]);
          const [delUser, setDelUser] = useState(null);
          const [showPass, setShowPass] = useState({});
          const t = TRANSLATIONS[lang].admin;

          const load = async () => setUsers(await StorageManager.getAllUsers());
          useEffect(() => { load(); }, []);

          const doDel = async () => {
             if(delUser) {
                await StorageManager.deleteUser(delUser.username);
                await load();
                setDelUser(null);
             }
          };

          const togglePass = (u) => setShowPass(p => ({...p, [u]: !p[u]}));

          return (
             <div className="pb-10">
                <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">{t.title}</h2><button onClick={onLogout} className="bg-slate-800 text-white px-4 py-2 rounded">{t.logout}</button></div>
                <div className="bg-white rounded-xl shadow overflow-x-auto">
                   <table className="w-full text-sm text-left">
                      <thead className="bg-slate-100 font-bold text-slate-700"><tr><th className="p-4">{t.col_user}</th><th className="p-4">{t.col_ip}</th><th className="p-4">{t.col_device}</th><th className="p-4">{t.col_pass}</th><th className="p-4">{t.col_score}</th><th className="p-4">{t.col_actions}</th></tr></thead>
                      <tbody>
                         {users.map(u => (
                            <tr key={u.username} className="border-t hover:bg-slate-50">
                               <td className="p-4 font-bold">{u.username}</td>
                               <td className="p-4 font-mono text-xs">{u.ip}</td>
                               <td className="p-4 font-mono text-xs text-slate-400" title={u.deviceId}>{u.deviceId ? u.deviceId.substring(0,8)+'...' : '-'}</td>
                               <td className="p-4 font-mono text-xs flex items-center gap-2">
                                  {showPass[u.username] ? u.password : '••••••'}
                                  <button onClick={()=>togglePass(u.username)} className="text-slate-400 hover:text-indigo-600">{showPass[u.username] ? <EyeOff size={14}/> : <Eye size={14}/>}</button>
                               </td>
                               <td className="p-4"><span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{Object.values(u.scores||{}).reduce((a,b)=>a+b,0)} pts</span></td>
                               <td className="p-4"><button onClick={()=>setDelUser(u)} className="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold">{t.btn_ban}</button></td>
                            </tr>
                         ))}
                      </tbody>
                   </table>
                </div>
                {delUser && (
                   <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                      <div className="bg-white p-6 rounded-xl max-w-sm w-full m-4">
                         <h3 className="text-xl font-bold text-red-600 mb-2">{t.btn_ban} {delUser.username}</h3>
                         <p className="mb-6">{t.confirm_ban}</p>
                         <div className="flex justify-end gap-3">
                            <button onClick={()=>setDelUser(null)} className="px-4 py-2 font-bold text-slate-600">{t.btn_cancel}</button>
                            <button onClick={doDel} className="px-4 py-2 bg-red-600 text-white rounded font-bold">{t.btn_ban}</button>
                         </div>
                      </div>
                   </div>
                )}
             </div>
          );
      };

      const Thermometer = () => {
          const [temp, setTemp] = useState(5);
          const getHeight = (t) => Math.min(Math.max(((t + 20) / 60) * 100, 0), 100);
          const getColor = (t) => t > 25 ? 'bg-red-500' : t > 0 ? 'bg-green-400' : 'bg-blue-500';
          return (
            <div className="flex flex-col md:flex-row items-center justify-center gap-8 p-6 h-full">
              <div className="w-full md:w-1/2 space-y-4">
                <input type="range" min="-20" max="40" value={temp} onChange={(e) => setTemp(parseInt(e.target.value))} className="w-full accent-slate-800"/>
                <div className="text-center p-4 bg-slate-50 rounded-xl border"><span className="text-3xl font-bold">{temp > 0 ? `+${temp}` : temp}°C</span></div>
              </div>
              <div className="relative h-64 w-16 bg-slate-200 rounded-full border-4 border-slate-300 flex justify-center">
                <div className="absolute right-0 top-0 h-full w-full flex flex-col justify-between py-4 pr-1 text-[10px] text-slate-400 font-mono items-end"><span>40</span><span>20</span><span>0</span><span>-20</span></div>
                <div className={`absolute bottom-2 w-8 rounded-t-lg rounded-b-full transition-all duration-300 ${getColor(temp)}`} style={{ height: `${getHeight(temp)}%` }}></div>
              </div>
            </div>
          );
      };

      const ElevatorVisual = () => {
          const floors = [3, 2, 1, 0, -1, -2, -3];
          return (
            <div className="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-3xl shadow-lg flex flex-col sm:flex-row items-center gap-6 h-full">
                <div className="flex-1">
                    <h2 className="text-2xl font-bold mb-2">Igogailua</h2>
                    <p className="opacity-90 text-sm">Sotoak negatiboak dira.</p>
                </div>
                <div className="bg-blue-900/40 p-4 rounded-xl border-2 border-blue-300/30 flex flex-col gap-2 relative z-10">
                    {floors.map(floor => (
                        <div key={floor} className="flex items-center gap-3">
                            <div className={`w-14 h-10 rounded-lg border-2 flex items-center justify-center font-mono font-bold text-lg shadow-md ${floor === 0 ? 'bg-white border-white text-blue-900' : 'bg-indigo-700 border-indigo-500 text-white'}`}>{floor}</div>
                            <span className="text-[10px] uppercase font-bold w-12">{floor === 0 ? 'Behea' : floor > 0 ? `${floor}` : `Soto ${Math.abs(floor)}`}</span>
                        </div>
                    ))}
                </div>
            </div>
          );
      };

      const NumberLine = () => {
          const [hl, setHl] = useState(null);
          const range = Array.from({ length: 21 }, (_, i) => i - 10);
          return (
            <div className="w-full p-6 bg-white rounded-2xl shadow-sm border border-slate-100 my-6 overflow-x-auto">
              <div className="flex items-center gap-2 min-w-[600px] justify-center">
                {range.map((num) => (
                  <button key={num} onClick={() => setHl(num)} className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${hl === num ? 'bg-slate-800 text-white scale-125' : 'bg-white border hover:bg-slate-100'}`}>{num}</button>
                ))}
              </div>
            </div>
          );
      };

      const NumberLineHunt = () => {
          const [pts, setPts] = useState(generateNumberLinePoints());
          const [inp, setInp] = useState({});
          const [chk, setChk] = useState(false);
          const check = () => setChk(true);
          return (
            <div className="bg-white p-6 rounded-2xl border">
                <div className="flex justify-between mb-6"><h3 className="font-bold">Non daude?</h3><button onClick={()=>{setPts(generateNumberLinePoints()); setInp({}); setChk(false)}}><RefreshCw/></button></div>
                <div className="relative h-16 flex items-center justify-center mb-8 bg-slate-100 rounded-full overflow-hidden">
                     {[-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7].map(n => {
                         const p = pts.find(x=>x.value===n);
                         return <div key={n} className="flex-1 text-center text-xs relative border-l border-slate-300 h-full pt-6">{n}{p && <div className="absolute top-1 left-1/2 -translate-x-1/2 bg-indigo-600 text-white w-5 h-5 rounded-full flex items-center justify-center font-bold">{p.label}</div>}</div>;
                     })}
                </div>
                <div className="flex justify-center gap-4">
                    {pts.map(p => (
                        <div key={p.id} className="flex flex-col items-center">
                            <label className="font-bold">{p.label} =</label>
                            <input type="number" value={inp[p.id]||''} onChange={e=>{setChk(false); setInp({...inp,[p.id]:e.target.value})}} className={`w-16 h-10 text-center border-2 rounded ${chk ? (parseInt(inp[p.id])===p.value ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500') : 'bg-white'}`} />
                        </div>
                    ))}
                </div>
                <div className="text-center mt-6"><button onClick={check} className="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold">Egiaztatu</button></div>
            </div>
          );
      };

      const OperationsDrill = ({lang}) => {
          const [m, setM] = useState('add');
          const [ex, setEx] = useState(generateOperation('add', lang));
          const [fb, setFb] = useState(null);
          const next = () => { setFb(null); setEx(m==='compare'?generateComparison():generateOperation(m, lang)); };
          useEffect(()=>{next()},[m]);
          const ans = (v) => { if(v===ex.correctAnswer){setFb('ok'); setTimeout(next,1000);}else setFb('no'); };
          return (
             <div className="bg-white rounded-2xl shadow p-6 text-center">
                <div className="flex gap-2 justify-center mb-8 overflow-x-auto">
                    {['compare','add','subtract','multiply','combined'].map(mod=><button key={mod} onClick={()=>setM(mod)} className={`px-3 py-1 rounded capitalize ${m===mod?'bg-slate-800 text-white':'bg-slate-100'}`}>{mod}</button>)}
                </div>
                <h3 className="text-4xl font-mono font-bold mb-8">{ex.question}</h3>
                <div className="grid grid-cols-2 gap-4 max-w-sm mx-auto">
                    {ex.options.map((o,i)=><button key={i} onClick={()=>ans(o)} className="p-4 bg-slate-50 border-b-4 border-slate-200 rounded-xl font-bold text-xl hover:bg-blue-50">{o>0?`+${o}`:o}</button>)}
                </div>
                <div className="h-8 mt-4 font-bold">{fb==='ok'?<span className="text-green-500">Zuzena!</span>:fb==='no'?<span className="text-red-500">Okerra...</span>:null}</div>
             </div>
          );
      };

      const WordProblems = () => {
          const [p, setP] = useState(generateWordProblem());
          const [ans, setAns] = useState('');
          const [st, setSt] = useState('idle');
          const [h, setH] = useState(false);
          return (
             <div className="bg-white p-6 rounded-2xl shadow h-full flex flex-col">
                 <p className="text-lg font-medium mb-6 flex-grow">{p.text}</p>
                 <div className="bg-slate-50 p-3 rounded-xl border mb-4 flex gap-2">
                     <input type="number" value={ans} onChange={e=>{setSt('idle'); setAns(e.target.value)}} className="w-full bg-transparent outline-none text-xl" placeholder="?"/>
                     <span className="font-bold text-slate-400">{p.unit}</span>
                 </div>
                 {h && <div className="text-sm text-amber-600 mb-4 bg-amber-50 p-2 rounded">Pista: {p.hint}</div>}
                 <div className="flex justify-between items-center">
                     <button onClick={()=>setH(true)} className="text-xs text-amber-600 font-bold"><Lightbulb size={14} className="inline"/> Pista</button>
                     <button onClick={()=>{ if(parseInt(ans)===p.correctAnswer) {setSt('ok'); setTimeout(()=>{setP(generateWordProblem());setAns('');setSt('idle');setH(false)},1500)} else setSt('no') }} className={`px-4 py-2 rounded-lg font-bold text-white ${st==='ok'?'bg-green-500':st==='no'?'bg-red-500':'bg-blue-600'}`}>{st==='ok'?'Zuzena!':st==='no'?'Okerra':'Egiaztatu'}</button>
                 </div>
             </div>
          );
      };

      const MathPyramid = () => {
          const [c, setC] = useState(generatePyramid());
          const [inp, setInp] = useState({});
          const [st, setSt] = useState(null);
          const check = () => { const ok = c.every(x => !x.isInput || parseInt(inp[x.id]) === x.value); setSt(ok?'ok':'no'); };
          return (
             <div className="flex flex-col items-center gap-2">
                 {[0,1,2].map(r => <div key={r} className="flex gap-2">{c.filter(x=>x.row===r).sort((a,b)=>a.col-b.col).map(x=>(<div key={x.id} className="w-16 h-12 border-2 flex items-center justify-center font-bold rounded">{x.isInput?<input type="number" className="w-full text-center bg-indigo-50" value={inp[x.id]||''} onChange={e=>setInp({...inp,[x.id]:e.target.value})}/>:x.value}</div>))}</div>)}
                 <button onClick={check} className="mt-4 bg-slate-800 text-white px-6 py-2 rounded font-bold">{st==='ok'?'Oso ongi!':st==='no'?'Saiatu berriro':'Egiaztatu'}</button>
             </div>
          );
      };
      
      const TrueFalseGame = () => {
          const [q, setQ] = useState(generateTrueFalse());
          const [st, setSt] = useState(null);
          const guess = (v) => { setSt(v===q.isTrue?'ok':'no'); };
          const next = () => { setQ(generateTrueFalse()); setSt(null); };
          return (
             <div className="text-center">
                 <div className="text-4xl font-mono font-bold py-8">{q.statement}</div>
                 {!st ? <div className="flex gap-4"><button onClick={()=>guess(false)} className="flex-1 bg-red-100 text-red-700 py-4 rounded-xl font-bold">Gezurra</button><button onClick={()=>guess(true)} className="flex-1 bg-green-100 text-green-700 py-4 rounded-xl font-bold">Egia</button></div>
                 : <div><div className={`font-bold mb-4 ${st==='ok'?'text-green-600':'text-red-600'}`}>{st==='ok'?'Zuzena!':'Okerra!'} {q.explanation}</div><button onClick={next} className="bg-slate-800 text-white px-6 py-2 rounded">Hurrengoa</button></div>}
             </div>
          );
      };

      const MemoryGame = () => {
          const [cds, setCds] = useState(generateMemoryDeck());
          const [sel, setSel] = useState([]);
          const click = (c) => {
              if(sel.length===2 || c.isFlipped || c.isMatched) return;
              const n = cds.map(x=>x.id===c.id?{...x,isFlipped:true}:x);
              setCds(n); setSel([...sel, c]);
              if(sel.length===1) {
                  setTimeout(()=>{
                      const m = sel[0].matchId === c.matchId;
                      setCds(prev=>prev.map(x=>(x.id===c.id||x.id===sel[0].id)?(m?{...x,isMatched:true}:{...x,isFlipped:false}):x));
                      setSel([]);
                  }, 1000);
              }
          };
          return (
             <div className="grid grid-cols-4 gap-2">
                 {cds.map(c=><button key={c.id} onClick={()=>click(c)} className={`aspect-square rounded flex items-center justify-center font-bold ${c.isFlipped||c.isMatched?'bg-indigo-600 text-white':'bg-slate-200 text-transparent'}`}>{c.content}</button>)}
             </div>
          );
      };

      // Speed Game Components
      const SpeedOps = ({ q, onAnswer }) => (
          <div className="text-center">
             <h3 className="text-3xl font-mono font-bold mb-6" style={{direction: 'ltr'}}>{q.question}</h3>
             <div className="grid grid-cols-2 gap-3">
                {q.options.map((opt, i) => (<button key={i} onClick={() => onAnswer(opt)} className="p-4 bg-white border-2 border-slate-200 rounded-xl font-bold text-xl hover:bg-indigo-50">{opt > 0 ? `+${opt}` : opt}</button>))}
             </div>
          </div>
      );
      const SpeedTF = ({ q, onAnswer, lang }) => (
          <div className="text-center">
             <h3 className="text-3xl font-mono font-bold mb-8" style={{direction: 'ltr'}}>{q.statement}</h3>
             <div className="flex gap-4">
                <button onClick={() => onAnswer(false)} className="flex-1 py-6 bg-red-100 text-red-700 rounded-xl font-bold text-xl border-2 border-red-200"><ThumbsDown className="mx-auto mb-1"/> {TRANSLATIONS[lang].games.tf.false}</button>
                <button onClick={() => onAnswer(true)} className="flex-1 py-6 bg-green-100 text-green-700 rounded-xl font-bold text-xl border-2 border-green-200"><ThumbsUp className="mx-auto mb-1"/> {TRANSLATIONS[lang].games.tf.true}</button>
             </div>
          </div>
      );
      const SpeedPyramid = ({ q, onAnswer, t_check }) => {
         const [inp, setInp] = useState({});
         const check = () => {
            const ok = q.cells.every(c => !c.isInput || parseInt(inp[c.id]) === c.value);
            onAnswer(ok);
         };
         return (
            <div className="flex flex-col items-center gap-2" style={{direction: 'ltr'}}>
               {[0,1,2].map(r => <div key={r} className="flex gap-2">{q.cells.filter(c=>c.row===r).sort((a,b)=>a.col-b.col).map(c=>(<div key={c.id} className="w-14 h-12 border-2 flex items-center justify-center font-bold rounded">{c.isInput ? <input type="number" className="w-full text-center bg-indigo-50" value={inp[c.id]||''} onChange={e=>setInp({...inp,[c.id]:e.target.value})}/> : c.value}</div>))}</div>)}
               <button onClick={check} className="mt-4 px-6 py-2 bg-indigo-600 text-white rounded font-bold">{t_check}</button>
            </div>
         );
      };

      const ChallengeMode = ({ lang, user, onUpdateUser }) => {
         const [mode, setMode] = useState(null);
         const [play, setPlay] = useState(false);
         const [score, setScore] = useState(0);
         const [time, setTime] = useState(60);
         const [q, setQ] = useState(null);
         const [res, setRes] = useState(null);
         const [final, setFinal] = useState(null);
         const [lbs, setLbs] = useState({});
         
         const t = TRANSLATIONS[lang].records;
         
         useEffect(() => {
            const loadLbs = async () => {
               const allUsers = await StorageManager.getAllUsers();
               const newLbs = {};
               ['ops','tf','pyr','compare','add','sub','mul','combined'].forEach(gid => {
                  newLbs[gid] = allUsers.filter(u=>u.scores?.[gid] && !u.banned).sort((a,b)=>b.scores[gid]-a.scores[gid]).slice(0,3);
               });
               setLbs(newLbs);
            };
            loadLbs();
         }, [play]);

         useEffect(() => {
            if(play && time > 0) {
               const i = setInterval(() => setTime(t=>t-1), 1000);
               return () => clearInterval(i);
            }
            if(time === 0 && play) end();
         }, [play, time]);

         const start = (m) => { setMode(m); setScore(0); setTime(60); setPlay(true); setFinal(null); next(m); };
         
         const next = (m) => {
            setRes(null);
            if(m==='ops') setQ(Math.random()>0.5 ? generateOperation('combined', lang) : generateComparison());
            else if(m==='tf') setQ(generateTrueFalse());
            else if(m==='pyr') setQ({cells:generatePyramid(), id:Math.random()});
            else if(m==='compare') setQ(generateComparison());
            else if(m==='add') setQ(generateOperation('add'));
            else if(m==='sub') setQ(generateOperation('subtract'));
            else if(m==='mul') setQ(generateOperation('multiply'));
            else if(m==='combined') setQ(generateOperation('combined'));
         };

         const end = async () => {
            setPlay(false);
            const r = await StorageManager.saveScore(user.username, mode, score);
            setFinal({ score, isRecord: r.isNewRecord });
            if(r.isNewRecord) onUpdateUser(r.user);
         };

         const ans = (val) => {
            if(final) return;
            let ok = false;
            if(mode==='tf') ok = (val === q.isTrue);
            else if(mode==='pyr') ok = val;
            else ok = (val === q.correctAnswer);
            
            if(ok) { setScore(s=>s+1); setRes('ok'); setTimeout(()=>next(mode), 200); }
            else { setScore(s=>s-2); setRes('no'); setTimeout(()=>next(mode), 200); }
         };

         if(!play && !final) {
             const games = [
               {id:'ops',c:'bg-blue-500'},{id:'tf',c:'bg-green-500'},{id:'pyr',c:'bg-purple-500'},
               {id:'compare',c:'bg-orange-500'},{id:'add',c:'bg-teal-500'},{id:'sub',c:'bg-red-500'},
               {id:'mul',c:'bg-indigo-500'},{id:'combined',c:'bg-pink-500'}
             ];
             return (
                <div className="space-y-6 pb-10">
                   <div className="text-center"><h2 className="text-3xl font-bold">{t.title}</h2><p className="text-slate-500">{t.subtitle}</p></div>
                   <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {games.map(g => (
                         <div key={g.id} className="bg-white rounded-xl shadow border overflow-hidden">
                            <div className={`h-2 ${g.c}`}></div>
                            <div className="p-4">
                               <h3 className="font-bold mb-2">{t['game_'+g.id]}</h3>
                               <div className="bg-slate-50 p-2 rounded text-xs">
                                  <div className="font-bold text-slate-400 mb-1">TOP 3</div>
                                  {lbs[g.id]?.map((u,i)=><div key={i} className="flex justify-between"><span>{i+1}. {u.username}</span><span className="font-bold text-indigo-600">{u.scores[g.id]}</span></div>) || '-'}
                               </div>
                            </div>
                            <button onClick={()=>start(g.id)} className="w-full py-2 bg-slate-800 text-white font-bold text-xs">{t.start}</button>
                         </div>
                      ))}
                   </div>
                </div>
             );
         }
         
         if(final) return <div className="text-center p-8 bg-white rounded-xl shadow-xl max-w-md mx-auto"><h2 className="text-3xl font-bold mb-4">{final.isRecord ? t.new_record : t.final_score}</h2><div className="text-6xl font-black text-indigo-600 mb-6">{final.score}</div><button onClick={()=>setFinal(null)} className="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">{t.back}</button></div>;

         return (
            <div className="max-w-xl mx-auto">
               <div className="flex justify-between bg-slate-800 text-white p-4 rounded-xl mb-6 shadow-lg"><div className="font-mono text-2xl font-bold flex items-center gap-2"><Timer/>{time}s</div><div className={`font-mono text-3xl font-bold ${res==='ok'?'text-green-400':res==='no'?'text-red-400':''}`}>{score}</div></div>
               <div className="bg-white p-8 rounded-xl shadow-xl border relative min-h-[300px] flex items-center justify-center">
                  {res && <div className="absolute inset-0 bg-white/80 z-10 flex items-center justify-center">{res==='ok'?<CheckCircle size={64} className="text-green-500"/>:<X size={64} className="text-red-500"/>}</div>}
                  {['ops','compare','add','sub','mul','combined'].includes(mode) && <SpeedOps q={q} onAnswer={ans}/>}
                  {mode==='tf' && <SpeedTF q={q} onAnswer={ans} lang={lang}/>}
                  {mode==='pyr' && <SpeedPyramid q={q} onAnswer={ans} t_check={t.check}/>}
               </div>
            </div>
         );
      };

      const Profile = ({ lang, user, onLogout, onDelete }) => {
         const t = TRANSLATIONS[lang].profile;
         const [del, setDel] = useState(false);
         return (
            <div className="max-w-2xl mx-auto space-y-6">
               <div className="bg-white p-6 rounded-xl shadow border flex items-center gap-4">
                  <div className="bg-slate-200 p-4 rounded-full"><User size={32}/></div>
                  <div><h2 className="text-2xl font-bold">{user.username}</h2><button onClick={onLogout} className="text-red-500 text-sm font-bold flex items-center gap-1"><LogOut size={14}/> {t.logout}</button></div>
               </div>
               <div className="bg-white p-6 rounded-xl shadow border">
                  <h3 className="font-bold mb-4 flex gap-2"><Trophy className="text-yellow-500"/> {t.best_scores}</h3>
                  <div className="grid grid-cols-4 gap-3 text-center">
                     {Object.entries(user.scores||{}).map(([k,v])=><div key={k} className="bg-slate-50 p-2 rounded border"><div className="text-xs text-slate-500 uppercase font-bold">{k}</div><div className="text-xl font-black text-indigo-600">{v}</div></div>)}
                  </div>
               </div>
               <div className="text-center pt-4">
                  {!del ? <button onClick={()=>setDel(true)} className="text-slate-400 hover:text-red-600 text-sm flex items-center justify-center gap-2 mx-auto"><Trash2 size={14}/> {t.delete_acc}</button> : <div className="flex justify-center gap-4"><button onClick={()=>setDel(false)} className="px-3 py-1 bg-slate-200 rounded text-xs font-bold">No</button><button onClick={()=>onDelete(user.username)} className="px-3 py-1 bg-red-600 text-white rounded text-xs font-bold">Si</button></div>}
               </div>
            </div>
         );
      };

      const App = () => {
         const [sec, setSec] = useState('intro');
         const [menu, setMenu] = useState(false);
         const [lang, setLang] = useState('eu');
         const [user, setUser] = useState(null);

         useEffect(() => { 
            if(user && !user.isAdmin){
               const i = setInterval(async ()=>{
                  const s = await StorageManager.checkUserStatus(user.username);
                  if(s!=='ok'){ alert("KONTUA ITXITA / CUENTA CERRADA"); setUser(null); setSec('intro'); }
               }, 3000);
               return ()=>clearInterval(i);
            }
         }, [user]);

         const handleLogin = (u) => { setUser(u); setSec(u.isAdmin ? 'admin' : 'intro'); };
         
         if(!user) return <div className="min-h-screen bg-slate-50"><div className="flex justify-end p-4"><LanguageSelector current={lang} onChange={setLang}/></div><AuthScreen lang={lang} onLogin={handleLogin}/></div>;
         
         if(user.isAdmin) return <div className="min-h-screen bg-slate-50 p-4"><div className="max-w-7xl mx-auto"><div className="flex justify-between mb-4"><span>Admin Console</span><LanguageSelector current={lang} onChange={setLang}/></div><AdminPanel lang={lang} onLogout={()=>setUser(null)}/></div></div>;

         const NavBtn = ({id, icon, label}) => <button onClick={()=>{setSec(id); setMenu(false);}} className={`flex items-center gap-2 px-3 py-2 rounded-full text-sm font-bold ${sec===id?'bg-slate-800 text-white':'text-slate-600 hover:bg-slate-100'}`}>{icon}{label}</button>;
         const t = TRANSLATIONS[lang];
         
         return (
            <div className="min-h-screen bg-slate-50 flex flex-col text-slate-800">
               <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur border-b">
                  <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                     <div className="flex items-center gap-2 font-bold text-xl cursor-pointer" onClick={()=>setSec('intro')}><div className="w-8 h-8 bg-indigo-600 text-white rounded flex items-center justify-center">Z</div><span className="hidden xl:inline">ZenbakiOsoak</span></div>
                     <div className="hidden md:flex gap-1.5"><NavBtn id="intro" icon={<Home size={18}/>} label={t.nav.intro}/><NavBtn id="number_line" icon={<Layout size={18}/>} label={t.nav.line}/><NavBtn id="operations" icon={<Calculator size={18}/>} label={t.nav.ops}/><NavBtn id="problems" icon={<BookOpen size={18}/>} label={t.nav.probs}/><NavBtn id="games" icon={<Star size={18}/>} label={t.nav.games}/><NavBtn id="records" icon={<Trophy size={18}/>} label={t.nav.records}/><NavBtn id="profile" icon={<User size={18}/>} label={t.nav.profile}/><div className="w-px h-6 bg-slate-200 mx-2"></div><LanguageSelector current={lang} onChange={setLang}/></div>
                     <button className="md:hidden p-2" onClick={()=>setMenu(!menu)}>{menu?<X/>:<Menu/>}</button>
                  </div>
                  {menu && <div className="md:hidden bg-white border-b p-4 space-y-2"><NavBtn id="intro" icon={<Home/>} label={t.nav.intro}/><NavBtn id="records" icon={<Trophy/>} label={t.nav.records}/><NavBtn id="profile" icon={<User/>} label={t.nav.profile}/></div>}
               </nav>
               <main className="flex-grow max-w-7xl mx-auto w-full p-4 py-8">
                  {sec==='intro' && <div className="text-center space-y-8"><h1 className="text-4xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">{t.title}</h1><p className="text-lg max-w-2xl mx-auto">{t.intro_desc}</p><div className="grid md:grid-cols-2 gap-8 text-left"><div className="bg-white p-6 rounded-2xl shadow"><Thermometer/></div><div className="space-y-6"><ElevatorVisual/><div className="bg-white p-6 rounded-2xl shadow"><strong>Z</strong>: ...-1, 0, 1...</div></div></div></div>}
                  {sec==='records' && <ChallengeMode lang={lang} user={user} onUpdateUser={setUser}/>}
                  {sec==='profile' && <Profile lang={lang} user={user} onLogout={()=>setUser(null)} onDelete={(u)=>{StorageManager.deleteUser(u); setUser(null);}}/>}
                  {sec==='number_line' && <div><NumberLine/><div className="my-8"><NumberLineHunt/></div></div>}
                  {sec==='operations' && <OperationsDrill lang={lang}/>}
                  {sec==='problems' && <div className="grid md:grid-cols-2 gap-6"><WordProblems/><WordProblems/><WordProblems/><WordProblems/></div>}
                  {sec==='games' && <div className="space-y-8"><div className="bg-white p-6 rounded-2xl border"><MathPyramid/></div><div className="grid md:grid-cols-2 gap-6"><TrueFalseGame lang={lang}/><MemoryGame lang={lang}/></div></div>}
               </main>
            </div>
         );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>